+++
title = "ç¬¬äº”ç«  è¡¨åˆ†åŒºä¸Žç»§æ‰¿ - ç¬¬äºŒèŠ‚ï¼šåŽŸç”Ÿåˆ†åŒº vs. ç»§æ‰¿åˆ†åŒº"
date = 2025-07-10
lastmod = 2025-07-10T01:00:00+08:00
tags = ["PostgreSQL", "practical", "book", "partitioning", "inheritance"]
categories = ["PostgreSQL", "practical", "book"]
draft = false
author = "b40yd"
+++

## ç¬¬äºŒèŠ‚ åŽŸç”Ÿåˆ†åŒº vs. ç»§æ‰¿åˆ†åŒº

> **ç›®æ ‡**ï¼šç†è§£ PostgreSQL ä¸­å®žçŽ°åˆ†åŒºçš„ä¸¤ç§åŽ†å²æ–¹å¼â€”â€”è¡¨ç»§æ‰¿ï¼ˆTable Inheritanceï¼‰å’ŒåŽŸç”Ÿåˆ†åŒºï¼ˆDeclarative Partitioningï¼‰ï¼Œå¹¶æ˜Žç¡®ä¸ºä»€ä¹ˆåœ¨çŽ°ä»£ç‰ˆæœ¬ï¼ˆPostgreSQL 10+ï¼‰ä¸­åº”å§‹ç»ˆé¦–é€‰åŽŸç”Ÿåˆ†åŒºã€‚

åœ¨ PostgreSQL 10 ç‰ˆæœ¬å‘å¸ƒä¹‹å‰ï¼Œå®žçŽ°è¡¨åˆ†åŒºçš„å”¯ä¸€æ–¹æ³•æ˜¯åˆ©ç”¨**è¡¨ç»§æ‰¿**æœºåˆ¶ï¼Œå¹¶é…åˆè§¦å‘å™¨å’Œ `CHECK` çº¦æŸæ¥æ‰‹åŠ¨â€œæ¨¡æ‹Ÿâ€åˆ†åŒºã€‚è¿™ä¸ªè¿‡ç¨‹ç›¸å½“ç¹çä¸”å®¹æ˜“å‡ºé”™ã€‚è‡ª PostgreSQL 10 å¼•å…¥äº†åŽŸç”Ÿçš„å£°æ˜Žå¼åˆ†åŒºåŽï¼Œåˆ†åŒºå®žçŽ°å˜å¾—å‰æ‰€æœªæœ‰çš„ç®€å•å’Œé«˜æ•ˆã€‚

æœ¬èŠ‚å°†å¸¦ä½ å›žé¡¾ä¼ ç»Ÿç»§æ‰¿åˆ†åŒºæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œå¹¶ä¸ŽçŽ°ä»£åŽŸç”Ÿåˆ†åŒºè¿›è¡Œå…¨æ–¹ä½å¯¹æ¯”ã€‚

---

## ðŸ“œ ä¸€ã€ä¼ ç»Ÿæ–¹å¼ï¼šä½¿ç”¨è¡¨ç»§æ‰¿å®žçŽ°åˆ†åŒº

è®©æˆ‘ä»¬çœ‹çœ‹åœ¨â€œçŸ³å™¨æ—¶ä»£â€ï¼ˆPostgreSQL 9.6 åŠæ›´æ—©ç‰ˆæœ¬ï¼‰ï¼Œè¦å®žçŽ°ä¸€ä¸ªæŒ‰æœˆåˆ†åŒºçš„æ—¥å¿—è¡¨éœ€è¦å¤šå°‘æ­¥éª¤ã€‚

### æ­¥éª¤ 1ï¼šåˆ›å»ºä¸»è¡¨ï¼ˆçˆ¶è¡¨ï¼‰
ä¸»è¡¨æ˜¯ä¸€ä¸ªæ™®é€šçš„è¡¨ï¼Œå®ƒæœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ã€‚
```sql
CREATE TABLE access_logs_parent (
    log_id      BIGSERIAL,
    ip_address  INET NOT NULL,
    log_time    TIMESTAMP WITH TIME ZONE NOT NULL,
    url         TEXT NOT NULL
);
```

### æ­¥éª¤ 2ï¼šåˆ›å»ºå­è¡¨ï¼ˆåˆ†åŒºï¼‰
æ¯ä¸ªå­è¡¨éƒ½ç»§æ‰¿è‡ªä¸»è¡¨ï¼Œå¹¶ä½¿ç”¨ `CHECK` çº¦æŸæ¥å®šä¹‰å®ƒæ‰€èƒ½å­˜å‚¨çš„æ•°æ®èŒƒå›´ã€‚
```sql
-- 2025å¹´1æœˆä»½çš„åˆ†åŒº
CREATE TABLE access_logs_y2025m01 (
    CHECK ( log_time >= '2025-01-01' AND log_time < '2025-02-01' )
) INHERITS (access_logs_parent);

-- 2025å¹´2æœˆä»½çš„åˆ†åŒº
CREATE TABLE access_logs_y2025m02 (
    CHECK ( log_time >= '2025-02-01' AND log_time < '2025-03-01' )
) INHERITS (access_logs_parent);
```

### æ­¥éª¤ 3ï¼šåˆ›å»ºè§¦å‘å™¨å‡½æ•°ä»¥è·¯ç”±æ•°æ®
ç”±äºŽæ•°æ®ç›´æŽ¥æ’å…¥çˆ¶è¡¨ `access_logs_parent` ä¸ä¼šè‡ªåŠ¨è·¯ç”±åˆ°å­è¡¨ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨å‡½æ•°æ¥æ‰‹åŠ¨å®Œæˆè¿™é¡¹å·¥ä½œã€‚

```sql
CREATE OR REPLACE FUNCTION access_logs_insert_trigger()
RETURNS TRIGGER AS $$
BEGIN
    IF ( NEW.log_time >= '2025-01-01' AND NEW.log_time < '2025-02-01' ) THEN
        INSERT INTO access_logs_y2025m01 VALUES (NEW.*);
    ELSIF ( NEW.log_time >= '2025-02-01' AND NEW.log_time < '2025-03-01' ) THEN
        INSERT INTO access_logs_y2025m02 VALUES (NEW.*);
    ELSE
        RAISE EXCEPTION 'Date out of range.  Fix the access_logs_insert_trigger() function!';
    END IF;
    RETURN NULL; -- é˜»æ­¢å‘çˆ¶è¡¨ä¸­æ’å…¥æ•°æ®
END;
$$
LANGUAGE plpgsql;
```

### æ­¥éª¤ 4ï¼šåœ¨ä¸»è¡¨ä¸Šåˆ›å»ºè§¦å‘å™¨
```sql
CREATE TRIGGER insert_access_logs_trigger
    BEFORE INSERT ON access_logs_parent
    FOR EACH ROW EXECUTE FUNCTION access_logs_insert_trigger();
```

**å°ç»“**ï¼šæ•´ä¸ªè¿‡ç¨‹éžå¸¸å¤æ‚ï¼Œæ¶‰åŠæ‰‹åŠ¨åˆ›å»ºçº¦æŸã€ç¼–å†™å’Œç»´æŠ¤è§¦å‘å™¨ï¼Œæ¯å½“å¢žåŠ æ–°åˆ†åŒºæ—¶ï¼Œéƒ½éœ€è¦ä¿®æ”¹è§¦å‘å™¨å‡½æ•°ï¼Œæžæ˜“å‡ºé”™ã€‚

---

## âœ¨ äºŒã€çŽ°ä»£æ–¹å¼ï¼šåŽŸç”Ÿå£°æ˜Žå¼åˆ†åŒº

çŽ°åœ¨ï¼Œè®©æˆ‘ä»¬å›žé¡¾ä¸€ä¸‹ä¸Šä¸€èŠ‚ä¸­åŽŸç”Ÿåˆ†åŒºçš„å®žçŽ°æ–¹å¼ï¼Œå¯¹æ¯”ä¹‹ä¸‹ï¼Œå…¶ç®€æ´æ€§ä¸€ç›®äº†ç„¶ã€‚

```sql
-- 1. åˆ›å»ºåˆ†åŒºä¸»è¡¨
CREATE TABLE access_logs (
    log_id      BIGSERIAL,
    ip_address  INET NOT NULL,
    log_time    TIMESTAMP WITH TIME ZONE NOT NULL,
    url         TEXT NOT NULL
) PARTITION BY RANGE (log_time);

-- 2. åˆ›å»ºåˆ†åŒº
CREATE TABLE access_logs_y2025m01 PARTITION OF access_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

CREATE TABLE access_logs_y2025m02 PARTITION OF access_logs
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```
**å®Œæˆï¼** ä¸éœ€è¦ä»»ä½•è§¦å‘å™¨ï¼Œä¸éœ€è¦æ‰‹åŠ¨å†™ `CHECK` çº¦æŸï¼ˆæ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºï¼‰ã€‚æ•°æ®æ’å…¥ `access_logs` åŽä¼šè‡ªåŠ¨ã€é«˜æ•ˆåœ°è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†åŒºã€‚

---

## ðŸ†š ä¸‰ã€å…¨æ–¹ä½å¯¹æ¯”ï¼šåŽŸç”Ÿåˆ†åŒº vs. ç»§æ‰¿åˆ†åŒº

| ç‰¹æ€§ | åŽŸç”Ÿåˆ†åŒº (Declarative Partitioning) | ç»§æ‰¿åˆ†åŒº (Inheritance-based) | ä¼˜åŠ¿æ–¹ |
| :--- | :--- | :--- | :--- |
| **å®žçŽ°å¤æ‚åº¦** | **æžä½Ž**ã€‚åªéœ€ `PARTITION BY` å’Œ `PARTITION OF`ã€‚ | **éžå¸¸é«˜**ã€‚éœ€è¦æ‰‹åŠ¨ç®¡ç† `INHERITS`, `CHECK` çº¦æŸå’Œè§¦å‘å™¨ã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **æ•°æ®æ’å…¥æ€§èƒ½** | **é«˜**ã€‚ç”±æ•°æ®åº“å†…æ ¸ç›´æŽ¥è·¯ç”±ï¼Œå¼€é”€æžå°ã€‚ | **è¾ƒä½Ž**ã€‚æ¯æ¬¡æ’å…¥éƒ½éœ€è¦æ‰§è¡Œè§¦å‘å™¨å‡½æ•°ï¼Œæœ‰é¢å¤–å¼€é”€ã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **æŸ¥è¯¢æ€§èƒ½** | **æ›´é«˜**ã€‚æŸ¥è¯¢ä¼˜åŒ–å™¨æœ‰æ›´å¤šå…³äºŽåˆ†åŒºç»“æž„çš„ä¿¡æ¯ï¼Œèƒ½ç”Ÿæˆæ›´ä¼˜çš„æ‰§è¡Œè®¡åˆ’ã€‚ | **è¾ƒå¥½**ã€‚ä¾èµ– `constraint_exclusion` å‚æ•°è¿›è¡Œåˆ†åŒºè£å‰ªï¼Œä½†ä¼˜åŒ–èƒ½åŠ›æœ‰é™ã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **åˆ†åŒºç®¡ç†** | **ç®€å•**ã€‚ä½¿ç”¨ `ATTACH/DETACH PARTITION` å‘½ä»¤ï¼Œæ“ä½œæ˜¯åŽŸå­æ€§çš„ä¸”é€Ÿåº¦æžå¿«ã€‚ | **å¤æ‚**ã€‚éœ€è¦æ‰‹åŠ¨ `ALTER TABLE ... INHERIT` å’Œ `NO INHERIT`ï¼Œå¹¶ç®¡ç†çº¦æŸã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **æ•°æ®ä¸€è‡´æ€§** | **å¼ºä¿è¯**ã€‚æ•°æ®åº“ä¿è¯æ•°æ®åªèƒ½è¿›å…¥å…¶æ‰€å±žçš„åˆ†åŒºã€‚ | **å¼±ä¿è¯**ã€‚ä¾èµ–äºŽ `CHECK` çº¦æŸå’Œè§¦å‘å™¨é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œå®¹æ˜“å‡ºé”™ã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **åŠŸèƒ½æ”¯æŒ** | æ”¯æŒ `UPDATE` è·¨åˆ†åŒºç§»åŠ¨è¡Œï¼›æ”¯æŒ `FOREIGN KEY`ï¼›æ›´å¥½çš„ç´¢å¼•æ”¯æŒã€‚ | ä¸æ”¯æŒ `UPDATE` è·¨åˆ†åŒºç§»åŠ¨ï¼›å¤–é”®æ”¯æŒæœ‰é™ã€‚ | **åŽŸç”Ÿåˆ†åŒº** |
| **çµæ´»æ€§** | ç»“æž„å›ºå®šï¼Œä¸æ”¯æŒä¸€ä¸ªåˆ†åŒºæœ‰é¢å¤–åˆ—ã€‚ | æ›´çµæ´»ï¼Œå­è¡¨å¯ä»¥æœ‰è‡ªå·±ç‹¬ç‰¹çš„åˆ—å’Œçº¦æŸã€‚ | ç»§æ‰¿åˆ†åŒº |

### ç»§æ‰¿åˆ†åŒºçš„å”¯ä¸€â€œä¼˜åŠ¿â€ï¼Ÿ

ç»§æ‰¿åˆ†åŒºå”¯ä¸€çš„ä¼˜åŠ¿åœ¨äºŽå…¶çµæ´»æ€§â€”â€”å­è¡¨å¯ä»¥æ‹¥æœ‰çˆ¶è¡¨æ²¡æœ‰çš„åˆ—ã€‚ä½†è¿™åœ¨ç»å¤§å¤šæ•°åˆ†åŒºåœºæ™¯ä¸‹å¹¶éžå¿…è¦ï¼Œåè€Œå¯èƒ½ç ´åæ•°æ®æ¨¡åž‹çš„ç»Ÿä¸€æ€§ã€‚å¯¹äºŽéœ€è¦è¿™ç§å¼‚æž„æ•°æ®æ¨¡åž‹çš„åœºæ™¯ï¼Œé€šå¸¸æœ‰æ›´å¥½çš„è®¾è®¡æ¨¡å¼å¯ä»¥æ›¿ä»£ã€‚

---

## ðŸ“Œ ç»“è®º

**å¯¹äºŽ PostgreSQL 10 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œè¯·å§‹ç»ˆä½¿ç”¨åŽŸç”Ÿå£°æ˜Žå¼åˆ†åŒºã€‚**

åŽŸç”Ÿåˆ†åŒºåœ¨æ€§èƒ½ã€æ˜“ç”¨æ€§ã€å¯ç»´æŠ¤æ€§å’Œæ•°æ®å®‰å…¨æ€§ä¸Šå…¨é¢è¶…è¶Šäº†åŸºäºŽç»§æ‰¿çš„è€æ–¹æ³•ã€‚å®ƒå°†åˆ†åŒºä»Žä¸€ä¸ªéœ€è¦æ•°æ®åº“ç®¡ç†å‘˜ï¼ˆDBAï¼‰ç²¾ç»†æ‰‹åŠ¨æ“ä½œçš„â€œé«˜çº§æŠ€å·§â€ï¼Œå˜ä¸ºäº†ä¸€ä¸ªå†…å»ºçš„ã€å¯é çš„ã€æ˜“äºŽä½¿ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ã€‚

äº†è§£ç»§æ‰¿åˆ†åŒºçš„å·¥ä½œåŽŸç†æœ‰åŠ©äºŽç†è§£ PostgreSQL çš„å‘å±•åŽ†å²ï¼Œä»¥åŠåœ¨ç»´æŠ¤æ—§ç³»ç»Ÿæ—¶å¯èƒ½é‡åˆ°çš„æƒ…å†µï¼Œä½†å¯¹äºŽæ‰€æœ‰æ–°é¡¹ç›®ï¼Œå®ƒéƒ½åº”è¯¥è¢«è§†ä¸ºå·²åºŸå¼ƒçš„æŠ€æœ¯ã€‚
