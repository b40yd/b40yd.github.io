+++
title = "ç¬¬äº”ç«  è¡¨åˆ†åŒºä¸Žç»§æ‰¿ - ç¬¬ä¸€èŠ‚ï¼šåŽŸç”Ÿåˆ†åŒºç­–ç•¥ (èŒƒå›´ã€åˆ—è¡¨ã€å“ˆå¸Œ)"
date = 2025-07-10
lastmod = 2025-07-10T01:00:00+08:00
tags = ["PostgreSQL", "practical", "book", "partitioning", "range", "list", "hash"]
categories = ["PostgreSQL", "practical", "book"]
draft = false
author = "b40yd"
+++

# ç¬¬äº”ç«  è¡¨åˆ†åŒºä¸Žç»§æ‰¿
## ç¬¬ä¸€èŠ‚ åŽŸç”Ÿåˆ†åŒºç­–ç•¥ (èŒƒå›´ã€åˆ—è¡¨ã€å“ˆå¸Œ)

> **ç›®æ ‡**ï¼šç†è§£è¡¨åˆ†åŒºçš„æ ¸å¿ƒæ¦‚å¿µä¸Žä¼˜åŠ¿ï¼Œå¹¶ç†Ÿç»ƒæŽŒæ¡ PostgreSQL 17 æä¾›çš„ä¸‰ç§åŽŸç”Ÿåˆ†åŒºç­–ç•¥ï¼šèŒƒå›´ï¼ˆRangeï¼‰ã€åˆ—è¡¨ï¼ˆListï¼‰å’Œå“ˆå¸Œï¼ˆHashï¼‰ã€‚

å½“ä¸€å¼ è¡¨çš„æ•°æ®é‡å¢žé•¿åˆ°æ•°åƒä¸‡ç”šè‡³æ•°åäº¿è¡Œæ—¶ï¼ŒæŸ¥è¯¢å’Œç»´æŠ¤æ€§èƒ½ä¼šæ€¥å‰§ä¸‹é™ã€‚ç´¢å¼•ä¼šå˜å¾—è‡ƒè‚¿ï¼Œ`VACUUM` æ“ä½œè€—æ—¶æ¼«é•¿ï¼Œç®€å•çš„æŸ¥è¯¢ä¹Ÿå¯èƒ½éœ€è¦æ‰«æå¤§é‡æ— å…³æ•°æ®ã€‚è¡¨åˆ†åŒºï¼ˆTable Partitioningï¼‰æ­£æ˜¯è§£å†³è¿™ä¸€é—®é¢˜çš„å…³é”®æŠ€æœ¯ã€‚

**è¡¨åˆ†åŒº**æ˜¯å°†ä¸€ä¸ªé€»è¾‘ä¸Šçš„å¤§è¡¨ï¼Œæ ¹æ®ç‰¹å®šè§„åˆ™ï¼ˆåˆ†åŒºé”®ï¼‰ï¼Œç‰©ç†ä¸Šåˆ†å‰²æˆå¤šä¸ªæ›´å°ã€æ›´æ˜“äºŽç®¡ç†çš„å­è¡¨ï¼ˆåˆ†åŒºï¼‰çš„è¿‡ç¨‹ã€‚å¯¹äºŽåº”ç”¨ç¨‹åºæ¥è¯´ï¼Œå®ƒè®¿é—®çš„ä»ç„¶æ˜¯ä¸»è¡¨ï¼ˆåˆ†åŒºè¡¨ï¼‰ï¼Œæ•°æ®åº“ä¼šè‡ªåŠ¨å°†æŸ¥è¯¢è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†åŒºä¸Šã€‚

### åˆ†åŒºçš„ä¸»è¦ä¼˜åŠ¿ï¼š
- **æŸ¥è¯¢æ€§èƒ½æå‡**ï¼šæŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥æ ¹æ® `WHERE` å­å¥ä¸­çš„æ¡ä»¶ï¼Œåªæ‰«æç›¸å…³çš„åˆ†åŒºï¼ˆè¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºâ€œåˆ†åŒºè£å‰ªâ€ï¼ŒPartition Pruningï¼‰ï¼Œé¿å…å…¨è¡¨æ‰«æã€‚
- **ç»´æŠ¤æ•ˆçŽ‡æ›´é«˜**ï¼šå¯ä»¥å¯¹å•ä¸ªåˆ†åŒºè¿›è¡Œ `VACUUM`ã€`REINDEX` æˆ–å¤‡ä»½ï¼Œæ“ä½œæ—¶é—´å¤§å¤§ç¼©çŸ­ã€‚å¯¹äºŽåŽ†å²æ•°æ®ï¼Œå¯ä»¥ç›´æŽ¥é™„åŠ ï¼ˆAttachï¼‰æˆ–åˆ†ç¦»ï¼ˆDetachï¼‰åˆ†åŒºï¼Œå®žçŽ°ç§’çº§æ•°æ®å½’æ¡£æˆ–åŠ è½½ã€‚
- **æ‰¹é‡åŠ è½½/åˆ é™¤æ›´å¿«**ï¼šé€šè¿‡ `DROP` æ•´ä¸ªåˆ†åŒºæ¥åˆ é™¤å¤§é‡æ•°æ®ï¼Œè¿œæ¯” `DELETE` å‘½ä»¤å¿«å¾—å¤šã€‚

PostgreSQL æä¾›äº†ä¸‰ç§åŽŸç”Ÿçš„åˆ†åŒºæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬é€ä¸€è¯¦è§£ã€‚

---

## ðŸ“ˆ 1. èŒƒå›´åˆ†åŒº (Range Partitioning)

èŒƒå›´åˆ†åŒºæ˜¯æœ€å¸¸è§çš„åˆ†åŒºç±»åž‹ï¼Œå®ƒæ ¹æ®åˆ†åŒºé”®çš„è¿žç»­èŒƒå›´å°†æ•°æ®åˆ†é…åˆ°ä¸åŒçš„åˆ†åŒºã€‚éžå¸¸é€‚åˆå¤„ç†å…·æœ‰æ—¶é—´åºåˆ—ç‰¹æ€§çš„æ•°æ®ï¼Œå¦‚æ—¥å¿—ã€äº¤æ˜“è®°å½•ã€ç‰©è”ç½‘ä¼ æ„Ÿå™¨æ•°æ®ç­‰ã€‚

### è¯­æ³•ç»“æž„

```sql
CREATE TABLE measurement (
    city_id         int not null,
    logdate         date not null,
    peaktemp        int,
    unitsales       int
) PARTITION BY RANGE (logdate);
```

### å®žæˆ˜ç¤ºä¾‹ï¼šæŒ‰æœˆåˆ†åŒºçš„æ—¥å¿—è¡¨

å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª `access_logs` è¡¨ï¼Œéœ€è¦æŒ‰æœˆè¿›è¡Œåˆ†åŒºã€‚

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåˆ†åŒºä¸»è¡¨**
```sql
CREATE TABLE access_logs (
    log_id      BIGSERIAL,
    ip_address  INET NOT NULL,
    log_time    TIMESTAMP WITH TIME ZONE NOT NULL,
    url         TEXT NOT NULL,
    PRIMARY KEY (log_id, log_time) -- åˆ†åŒºé”®å¿…é¡»æ˜¯ä¸»é”®æˆ–å”¯ä¸€çº¦æŸçš„ä¸€éƒ¨åˆ†
) PARTITION BY RANGE (log_time);
```

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå…·ä½“çš„åˆ†åŒº**
æ¯ä¸ªåˆ†åŒºéƒ½å­˜å‚¨ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ•°æ®ã€‚
```sql
-- 2025å¹´1æœˆä»½çš„åˆ†åŒº
CREATE TABLE access_logs_y2025m01 PARTITION OF access_logs
    FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- 2025å¹´2æœˆä»½çš„åˆ†åŒº
CREATE TABLE access_logs_y2025m02 PARTITION OF access_logs
    FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
```

**ç¬¬ä¸‰æ­¥ï¼šæ’å…¥å’ŒæŸ¥è¯¢**
æ•°æ®æ’å…¥ä¸»è¡¨åŽï¼Œä¼šè‡ªåŠ¨è·¯ç”±åˆ°æ­£ç¡®çš„åˆ†åŒºã€‚
```sql
INSERT INTO access_logs (ip_address, log_time, url)
VALUES ('192.168.1.100', '2025-01-15 10:00:00+08', '/home');

-- è¿™ä¸ªæŸ¥è¯¢å°†åªä¼šæ‰«æ access_logs_y2025m01 åˆ†åŒº
EXPLAIN SELECT * FROM access_logs WHERE log_time >= '2025-01-10' AND log_time < '2025-01-20';
```

---

## ðŸ—‚ï¸ 2. åˆ—è¡¨åˆ†åŒº (List Partitioning)

åˆ—è¡¨åˆ†åŒºæ ¹æ®åˆ†åŒºé”®çš„ç¦»æ•£å€¼åˆ—è¡¨æ¥ç»„ç»‡æ•°æ®ã€‚å®ƒé€‚ç”¨äºŽåˆ†åŒºé”®çš„å€¼æ˜¯æœ‰é™ä¸”å›ºå®šçš„åœºæ™¯ï¼Œå¦‚å›½å®¶ä»£ç ã€äº§å“ç±»åˆ«ã€åŸŽå¸‚ç­‰ã€‚

### è¯­æ³•ç»“æž„

```sql
CREATE TABLE sales (
    sale_id     BIGSERIAL,
    country     TEXT NOT NULL,
    amount      NUMERIC
) PARTITION BY LIST (country);
```

### å®žæˆ˜ç¤ºä¾‹ï¼šæŒ‰å›½å®¶åˆ†åŒºçš„é”€å”®æ•°æ®è¡¨

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåˆ†åŒºä¸»è¡¨**
```sql
CREATE TABLE sales_by_country (
    sale_id     BIGSERIAL,
    country     TEXT NOT NULL,
    amount      NUMERIC,
    sale_date   DATE,
    PRIMARY KEY (sale_id, country)
) PARTITION BY LIST (country);
```

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå…·ä½“çš„åˆ†åŒº**
æ¯ä¸ªåˆ†åŒºå¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå›½å®¶çš„æ•°æ®ã€‚
```sql
-- äºšæ´²å›½å®¶åˆ†åŒº
CREATE TABLE sales_asia PARTITION OF sales_by_country
    FOR VALUES IN ('China', 'Japan', 'India');

-- æ¬§æ´²å›½å®¶åˆ†åŒº
CREATE TABLE sales_europe PARTITION OF sales_by_country
    FOR VALUES IN ('Germany', 'France', 'UK');

-- åŒ—ç¾Žå›½å®¶åˆ†åŒº
CREATE TABLE sales_north_america PARTITION OF sales_by_country
    FOR VALUES IN ('USA', 'Canada');

-- ä¸ºå…¶ä»–æ‰€æœ‰æƒ…å†µåˆ›å»ºä¸€ä¸ªé»˜è®¤åˆ†åŒº
CREATE TABLE sales_others PARTITION OF sales_by_country DEFAULT;
```
**æ³¨æ„**ï¼š`DEFAULT` åˆ†åŒºéžå¸¸æœ‰ç”¨ï¼Œå¯ä»¥é˜²æ­¢å› å‡ºçŽ°æœªé¢„æœŸçš„åˆ†åŒºé”®å€¼è€Œå¯¼è‡´æ’å…¥å¤±è´¥ã€‚

---

## #ï¸âƒ£ 3. å“ˆå¸Œåˆ†åŒº (Hash Partitioning)

å½“åˆ†åŒºé”®æ²¡æœ‰è‡ªç„¶çš„èŒƒå›´æˆ–åˆ—è¡¨å½’å±žï¼Œä½†ä½ å¸Œæœ›å°†æ•°æ®å‡åŒ€åœ°åˆ†å¸ƒåˆ°å›ºå®šæ•°é‡çš„åˆ†åŒºä¸­ä»¥å®žçŽ°è´Ÿè½½å‡è¡¡æ—¶ï¼Œå“ˆå¸Œåˆ†åŒºæ˜¯æœ€ä½³é€‰æ‹©ã€‚å®ƒé€šè¿‡å¯¹åˆ†åŒºé”®è®¡ç®—å“ˆå¸Œå€¼ï¼Œç„¶åŽæ ¹æ®å“ˆå¸Œå€¼çš„æ¨¡æ•°æ¥å†³å®šæ•°æ®åº”å­˜å…¥å“ªä¸ªåˆ†åŒºã€‚

### è¯­æ³•ç»“æž„

```sql
CREATE TABLE user_profiles (
    user_id     BIGINT,
    username    TEXT,
    email       TEXT
) PARTITION BY HASH (user_id);
```

### å®žæˆ˜ç¤ºä¾‹ï¼šæŒ‰ç”¨æˆ·IDåˆ†åŒºçš„ç”¨æˆ·è¡¨

**ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºåˆ†åŒºä¸»è¡¨**
```sql
CREATE TABLE users (
    user_id     BIGINT,
    username    TEXT,
    signup_date DATE,
    PRIMARY KEY (user_id) -- å“ˆå¸Œåˆ†åŒºé”®é€šå¸¸å°±æ˜¯ä¸»é”®
) PARTITION BY HASH (user_id);
```

**ç¬¬äºŒæ­¥ï¼šåˆ›å»ºå›ºå®šæ•°é‡çš„åˆ†åŒº**
å‡è®¾æˆ‘ä»¬æƒ³æŠŠç”¨æˆ·æ•°æ®å‡åŒ€åœ°åˆ†åˆ° 4 ä¸ªåˆ†åŒºä¸­ã€‚
```sql
CREATE TABLE users_p0 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 0);
CREATE TABLE users_p1 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 1);
CREATE TABLE users_p2 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 2);
CREATE TABLE users_p3 PARTITION OF users FOR VALUES WITH (MODULUS 4, REMAINDER 3);
```
- `MODULUS`ï¼šæŒ‡å®šæ€»çš„åˆ†åŒºæ•°é‡ã€‚
- `REMAINDER`ï¼šæŒ‡å®šå½“å‰åˆ†åŒºæŽ¥æ”¶çš„å“ˆå¸Œä½™æ•°ã€‚

æ•°æ®æ’å…¥æ—¶ï¼ŒPostgreSQL ä¼šè‡ªåŠ¨è®¡ç®— `user_id` çš„å“ˆå¸Œå€¼ï¼Œå¹¶æ ¹æ® `hash(user_id) % 4` çš„ç»“æžœå°†æ•°æ®æ”¾å…¥å¯¹åº”çš„åˆ†åŒºã€‚

---

## ðŸ“Œ å°ç»“

| åˆ†åŒºç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| :--- | :--- | :--- | :--- |
| **èŒƒå›´ (Range)** | æ—¶é—´åºåˆ—æ•°æ®ã€è¿žç»­å˜åŒ–çš„æ•°å€¼ | ä¾¿äºŽæŒ‰æ—¶é—´å½’æ¡£å’Œæ¸…ç† | å¯èƒ½å‡ºçŽ°æ•°æ®å€¾æ–œï¼ˆå¦‚èŠ‚å‡æ—¥æ•°æ®æš´å¢žï¼‰ |
| **åˆ—è¡¨ (List)** | åˆ†ç±»æ•°æ®ã€çŠ¶æ€ç ã€åœ°ç†ä½ç½® | åˆ†åŒºé€»è¾‘æ¸…æ™°ï¼Œç¬¦åˆä¸šåŠ¡ç›´è§‰ | åˆ†åŒºé”®çš„å€¼å¿…é¡»æ˜¯å¯æžšä¸¾çš„ |
| **å“ˆå¸Œ (Hash)** | å¸Œæœ›å‡åŒ€åˆ†å¸ƒæ•°æ®ï¼Œæ— æ˜Žæ˜¾ä¸šåŠ¡åˆ†ç»„ | æ•°æ®åˆ†å¸ƒå‡åŒ€ï¼Œé¿å…çƒ­ç‚¹ | å¤±åŽ»ä¸šåŠ¡ä¸Šçš„å¯è¯»æ€§ï¼Œä¸ä¾¿äºŽæŒ‰ä¸šåŠ¡å½’æ¡£ |

é€‰æ‹©æ­£ç¡®çš„åˆ†åŒºç­–ç•¥æ˜¯è®¾è®¡å¯æ‰©å±•æ•°æ®åº“æž¶æž„çš„ç¬¬ä¸€æ­¥ã€‚åœ¨ä¸‹ä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ¯”çŽ°ä»£åŽŸç”Ÿåˆ†åŒºä¸Žä¼ ç»Ÿçš„ç»§æ‰¿åˆ†åŒºæ–¹æ³•ï¼Œè®©ä½ æ›´æ·±åˆ»åœ°ç†è§£åŽŸç”Ÿåˆ†åŒºçš„ä¼˜åŠ¿ã€‚
